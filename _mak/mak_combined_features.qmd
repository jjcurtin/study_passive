---
title: "Combining GPS & Demo Features"
author: "JJC"
date: "`r lubridate::today()`"
format: 
  html: 
    embed-resources: true
    toc: true 
    toc_depth: 4
editor_options: 
  chunk_output_type: console
params:
  version: "v1"
---

## Status and Notes


## Set up

```{r}
#| include: false

options(conflicts.policy = "depends.ok")
library(tidyverse) 

source("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true")
source("https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true")
source("modeling/rename_feats.R")
path_shared <- format_path("risk/data_processed/shared")
path_features <- format_path("optimize/data_processed/features")
```

Read in feature files
```{r}
ema <- read_csv(here::here(path_shared, "features_ema_1x_day_1h.csv"), 
                show_col_types = FALSE) 
gps <- read_csv(here::here(path_shared, "features_gps_day_1h.csv"), 
                 show_col_types = FALSE) 
# demos <- read_csv(here::here(path_shared, "features_demographics.csv"), 
#                   show_col_types = FALSE) 
# monthly <- read_csv(here::here(path_shared, "features_monthly_day_1h.csv"), 
#                     show_col_types = FALSE) 
strat <- read_csv(here::here(path_shared, "strat_lh.csv"), 
                    show_col_types = FALSE) 
```

Check rows

- OK
```{r}
nrow(ema)
nrow(gps)
# nrow(monthly)
# nrow(demos)
nrow(strat)
```

Verify expected # of subids

- EMA sample (151) for EMA, Monthly, and Strat
- GPS sample (154) for GPS
- Full sample (154) for demos

```{r}
ema |> distinct(subid) |> nrow() 
gps |> distinct(subid) |> nrow() 
# monthly |> distinct(subid) |> nrow() 
# demos |> distinct(subid) |> nrow() 
strat |> distinct(subid) |> nrow() 
```

Remove `label_num` and possibly other features from gps 
Had previously removed var_location as well but keeping now
```{r}
gps <- gps |> 
  # select(-label_num) |> 
  # select(-contains("var_location"))  |> 
  select(-contains(".no")) |> 
  select(-contains("neutral")) |> 
  select(-contains("transit"))
```

Remove min features from EMA
```{r}
ema <- ema |> 
  select(-contains("min"))
```

Remove diff features from monthly
```{r}
# monthly <- monthly |> 
#   select(-contains("drecent"))
```


Look at features for each signal

- EMA looks good 
- GPS looks good
- Monthly features
```{r}
names(ema)
names(gps)
# names(monthly) 
# names(demos)
names(strat)
```

Remove duplicated rows because of Daylight savings
Only needed for 24 hour rolls
```{r}
# ema <- ema |> distinct(subid, dttm_label, .keep_all = TRUE)
# gps <- gps |> distinct(subid, dttm_label, .keep_all = TRUE)
# monthly <- monthly |> distinct(subid, dttm_label, .keep_all = TRUE)
```


Join all files using left joins starting with GPS for that sample
Also join in strat lh
```{r}
all <- left_join(gps, ema, by = c("subid", "dttm_label", "lapse"))
nrow(all)

# all <- left_join(all, monthly, by = c("subid", "dttm_label", "lapse"))
# nrow(all)

#all <- left_join(all, demos, by = c("subid"))
#nrow(all)

all <- left_join(all, strat, by = c("subid"))
nrow(all)

all <- all |> 
  rename_features_stage1()

names(all)
```


Check outcome.  Looks good!
```{r}
all |> tab(lapse) 
```

Write out file
```{r}
all |> write_csv(here::here(path_features, 
                            str_c("features_", 
                                  params$version, ".csv")))
```